from telegram import Update
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext
import openai

TELEGRAM_BOT_TOKEN = "8449867090:AAFMH1SeEvQhCSfSBAvbIik2vvFri0j359Y"
OPENAI__API_KEY = "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"

openai.api_key = OPENAI_API_KEY

user_conversations = {}


def start(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    user_conversations[user_id] = []
    
    update.message.reply_text(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç —Å ChatGPT.\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ —á—Ç–æ-–Ω–∏–±—É–¥—å, –∏ —è –æ—Ç–≤–µ—á—É!\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/start - –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\n"
        "/clear - –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é\n"
        "/help - –ø–æ–º–æ—â—å"
    )


def help_command(update: Update, context: CallbackContext):
    update.message.reply_text(
        "üí° –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:\n\n"
        "1. –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å\n"
        "2. –Ø –æ—Ç–≤–µ—á—É —á–µ—Ä–µ–∑ ChatGPT\n"
        "3. –ë–æ—Ç –ø–æ–º–Ω–∏—Ç –Ω–∞—à—É –±–µ—Å–µ–¥—É\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/start - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å\n"
        "/clear - –∑–∞–±—ã—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é\n"
        "/help - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ"
    )


def clear_history(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    user_conversations[user_id] = []
    update.message.reply_text("‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞!")


def handle_message(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    user_message = update.message.text
    
    if user_id not in user_conversations:
        user_conversations[user_id] = []
    
    user_conversations[user_id].append({
        "role": "user",
        "content": user_message
    })
    
    context.bot.send_chat_action(chat_id=update.effective_chat.id, action="typing")
    
    try:
        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo",
            messages=user_conversations[user_id],
            max_tokens=1000,
            temperature=0.7
        )
        
        bot_reply = response.choices[0].message.content
        
        user_conversations[user_id].append({
            "role": "assistant",
            "content": bot_reply
        })
        
        if len(user_conversations[user_id]) > 20:
            user_conversations[user_id] = user_conversations[user_id][-20:]
        
        update.message.reply_text(bot_reply)
        
    except Exception as e:
        error_message = str(e)
        
        if "Incorrect API key" in error_message or "authentication" in error_message.lower():
            update.message.reply_text("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π OpenAI API –∫–ª—é—á!")
        elif "rate_limit" in error_message.lower():
            update.message.reply_text("‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ.")
        elif "insufficient_quota" in error_message.lower() or "quota" in error_message.lower():
            update.message.reply_text("üí∞ –ù–∞ OpenAI –∞–∫–∫–∞—É–Ω—Ç–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –¥–µ–Ω—å–≥–∏.")
        else:
            update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: {error_message}")


def main():
    if "–í–°–¢–ê–í–¨–¢–ï" in TELEGRAM_BOT_TOKEN or "–í–°–¢–ê–í–¨–¢–ï" in OPENAI_API_KEY:
        print("‚ùå –í—ã –Ω–µ –≤—Å—Ç–∞–≤–∏–ª–∏ —Ç–æ–∫–µ–Ω—ã! –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –∏—Ö.")
        input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
        return
    
    print("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
    
    try:
        updater = Updater(token=TELEGRAM_BOT_TOKEN, use_context=True)
        dispatcher = updater.dispatcher
        
        dispatcher.add_handler(CommandHandler("start", start))
        dispatcher.add_handler(CommandHandler("help", help_command))
        dispatcher.add_handler(CommandHandler("clear", clear_history))
        dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_message))
        
        print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
        print("‚å®Ô∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C\n")
        
        updater.start_polling()
        updater.idle()
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")


if name == "main":
    main()
